<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>NLO Admin</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
    <link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"
    >

    <link rel="stylesheet" href="/admin/static/css/2.b74256fb.chunk.css">
    <link rel="stylesheet" href="/admin/static/css/main.913a54c0.chunk.css">
    <link rel="stylesheet" href="/admin/nlo-admin.css?v=20260221-posts-i18n-status-1">

    <script>
      (() => {
        const host = (window.location.hostname || '').toLowerCase();
        const isLocalHost =
          host === 'localhost' ||
          host === '127.0.0.1' ||
          host === '::1' ||
          host.endsWith('.local');

        window.__nloAdminIsLocalHost = isLocalHost;
        if (!isLocalHost) {
          document.documentElement.setAttribute('data-nlo-admin-remote', '1');
        }
      })();
    </script>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <script>
      (() => {
        if (window.__nloAdminIsLocalHost) return;

        const root = document.getElementById('root');
        if (root) {
          root.style.display = 'none';
        }

        const notice = document.createElement('main');
        notice.className = 'nlo-admin-remote-notice';
        notice.innerHTML =
          '<h1>Админ-панель доступна только локально</h1>' +
          '<p>The <code>/admin</code> route is disabled for production usage.</p>' +
          '<p>Запустите проект локально и откройте <code>http://127.0.0.1:4000/admin</code>.</p>' +
          '<pre><code>bash tools/run.sh --admin</code></pre>' +
          '<p><a href="/">Вернуться на сайт</a></p>';
        document.body.appendChild(notice);
      })();
    </script>

    <script>
      (() => {
        if (!window.__nloAdminIsLocalHost) return;

        if (!window.fetch || !window.URL || !window.Response) return;

        const originalFetch = window.fetch.bind(window);
        const origin = window.location.origin;
        let cachedConfigPayload = null;
        window.__nloAdminConfigFetchOk = false;

        function parseUrl(input) {
          try {
            return new URL(typeof input === 'string' ? input : input.url, origin);
          } catch {
            return null;
          }
        }

        function isConfigPath(pathname) {
          return (
            pathname === '/_api/configuration' ||
            pathname === '/admin/_api/configuration' ||
            pathname === '/admin/configuration' ||
            pathname === '/configuration'
          );
        }

        function normalizeUrl(url) {
          if (!url) return null;

          if (url.pathname.startsWith('/admin/_api/')) {
            url.pathname = url.pathname.replace('/admin/_api/', '/_api/');
            return url;
          }

          if (url.pathname === '/admin/configuration' || url.pathname === '/configuration') {
            url.pathname = '/_api/configuration';
          }

          return url;
        }

        function rememberConfigPayload(text) {
          if (!text) return false;
          try {
            JSON.parse(text);
            cachedConfigPayload = text;
            window.__nloAdminConfigFetchOk = true;
            return true;
          } catch {
            return false;
          }
        }

        function configResponseFromCache() {
          return new Response(cachedConfigPayload || '{}', {
            status: 200,
            headers: { 'Content-Type': 'application/json; charset=utf-8' }
          });
        }

        const warmupUrl = new URL('/_api/configuration', origin);
        warmupUrl.searchParams.set('_prefetch', '1');
        originalFetch(warmupUrl.toString(), {
          credentials: 'same-origin',
          cache: 'no-store'
        })
          .then((response) => (response.ok ? response.text() : ''))
          .then((text) => {
            rememberConfigPayload(text);
          })
          .catch(() => {});

        window.fetch = (input, init) => {
          const parsed = parseUrl(input);
          const normalized = normalizeUrl(parsed ? new URL(parsed.toString()) : null);
          const isConfigRequest = normalized && isConfigPath(normalized.pathname);

          if (isConfigRequest && cachedConfigPayload) {
            return Promise.resolve(configResponseFromCache());
          }

          let nextInput = input;
          if (normalized && parsed && normalized.toString() !== parsed.toString()) {
            nextInput =
              typeof input === 'string' ? normalized.toString() : new Request(normalized.toString(), input);
          }

          return originalFetch(nextInput, init).then((response) => {
            if (!isConfigRequest) {
              return response;
            }

            return response
              .clone()
              .text()
              .then((text) => {
                if (rememberConfigPayload(text)) {
                  return response;
                }

                const retryUrl = new URL('/_api/configuration', origin);
                retryUrl.searchParams.set('_', String(Date.now()));
                return originalFetch(retryUrl.toString(), {
                  credentials: 'same-origin',
                  cache: 'no-store'
                })
                  .then((retryResponse) =>
                    retryResponse
                      .clone()
                      .text()
                      .then((retryText) => {
                        if (rememberConfigPayload(retryText)) {
                          return retryResponse;
                        }
                        if (cachedConfigPayload) {
                          return configResponseFromCache();
                        }
                        return retryResponse;
                      })
                  )
                  .catch(() => {
                    if (cachedConfigPayload) {
                      return configResponseFromCache();
                    }
                    return response;
                  });
              });
          });
        };
      })();
    </script>

    <script src="/admin/static/js/runtime-main.95f94e60.js"></script>
    <script src="/admin/static/js/2.08ea13e0.chunk.js"></script>
    <script src="/admin/static/js/main.a0831f44.chunk.js"></script>
    <script defer src="/admin/nlo-admin.js?v=20260221-posts-i18n-status-1"></script>
  </body>
</html>
